# 1. 락이란 무엇인가?

락의 뜻을 그대로 풀어보자면, “잠그다”이다. 이것만 들었을 때는 “무언가 오지 않게 접근을 막는 건가?”라는 생각이 든다. 락은 데이터베이스뿐만 아니라 다양한 분야에서도 적용되는 개념이지만, 이번에는 데이터베이스에서 말하는 락이 무엇인지 확인해보고자 한다.

> 💡 **락이란** 여러 트랜잭션이 동일한 데이터에 동시에 접근할 때, **일관성과 무결성을 보장하기 위해 사용되는 동시성 제어의 핵심 메커니즘**이다.

여기에서 여러 트랜잭션이 동일한 데이터에 동시에 접근하는 과정이 와닿지 않을 수 있어 아래와 같이 예시를 들어본다.

---

> ❓ **은행 계좌에서 잔액을 동시에 갱신하는 상황**
>
> 1. 계좌 A의 현재 잔액이 1000원이라고 가정한다.
> 2. 여기에서 동시에 두 트랜잭션이 발생한다.
     >     - 계좌 A에서 500원을 출금한다.
>     - 계좌 A에서 300원을 입금한다.
> 3. 두 트랜잭션이 동시에 접근하거나 접근하는 순서에 따라 값이 달라진다. (일관성이 없어짐)
     >     - 1000원 + 300원 입금 → 1300원
>     - 1000원 - 500원 출금 → 500원  
        >     **→ 올바른 값은 800원**이 남아야 한다.

---

# 2. 락의 종류는 무엇이 있는가?

## 1. 공유 락 (Shared Lock, Read Lock, S-Lock)
- **개념**  
  데이터를 읽을 때 사용되는 락으로 데이터를 읽는 동안 다른 트랜잭션에서도 읽기 작업은 가능하지만, **쓰기 작업은 불가능하다**. 즉, 읽기 작업을 위해 데이터를 잠그는 것을 의미한다.

- **특징**
    - A 트랜잭션에서 읽기 작업을 할 때, B 트랜잭션에서 읽기 작업을 해도 데이터에 대한 정합성은 지킬 수 있기 때문에 공유 락을 막을 이유가 없다.
    - 하지만 A 트랜잭션에서 읽기 작업을 할 때, B 트랜잭션에서 데이터에 대한 **쓰기 작업이 수행되면** 정합성이 깨질 수 있으므로 **배타 락** 획득을 막는다.

> ⭐ **세션 A가 특정 데이터를 읽기 위해 공유 락을 획득한 상태라면, 다른 세션 B도 같은 데이터를 공유 락을 걸고 읽을 수 있지만, 어떤 세션도 해당 데이터를 배타 락을 걸고 수정할 수 없다.**

---

## 2. 배타 락 (Exclusive Lock, Write Lock, X-Lock)
- **개념**  
  데이터를 **읽거나 쓰는 작업**을 수행할 때 사용되며, 해당 데이터에 대한 **다른 모든 트랜잭션의 접근을 차단**한다.  
  데이터를 보호하기 위해 **하나의 트랜잭션만 데이터에 접근하도록 제한**하는 것을 의미한다.

- **특징**
    - A 트랜잭션에서 쓰기 작업을 수행할 때, B 트랜잭션에서 해당 데이터를 읽는다면 **작업 결과가 달라질 수 있기 때문에** 다른 트랜잭션의 공유 락 획득을 막는다.

> ⭐ **트랜잭션 A가 특정 데이터를 쓰기 위해 배타 락을 획득하면, 다른 세션이 해당 데이터를 읽거나 수정하기 위해 공유 락 또는 배타 락을 획득하는 것이 불가능하다.**  
> **“내가 데이터를 쓰는 동안 해당 데이터를 읽거나 변경하려고 하지 마라!”**

---

# 3. 락의 설정 범위 (Level)란 무엇인가?

## 1. 설정 범위란?
락의 종류에 대해 확인한 후, 이제는 **락이 적용되는 데이터의 범위**에 대해 알아본다.  
락의 범위를 작게 설정할수록 **동시성은 높아지지만 락 관리 비용이 증가**하고, 크게 설정할수록 **동시성은 낮아지지만 관리 비용은 줄어드는** 특성이 있다.

## 2. 데이터베이스 락
- 데이터베이스를 기준으로 락의 범위를 정하며, 1개의 세션(연결)만이 DB 데이터에 접근할 수 있다.
- 일반적으로는 사용하지 않고 DB 소프트웨어 버전을 올리거나 주요한 DB 업데이트에 사용한다.

## 3. 파일
- 데이터베이스 파일을 기준으로 락의 범위를 정한다. 여기서 말하는 파일은 테이블, 행(Row) 등 실제 데이터가 저장된 물리적 저장소를 의미한다.
- 일반적으로 잘 사용되지 않는다.

## 4. 테이블
- 테이블을 기준으로 락의 범위를 정한다. 테이블의 모든 행을 업데이트하는 것과 같이 **전체 테이블에 영향을 주는 변경**에 유용하다.
- DDL(create, alter, drop 등) 구문과 함께 사용되며 **DDL Lock**이라고도 한다.

## 5. 페이지와 블록
## 6. 컬럼
## 7. 행
- **행 수준의 락은 특정 행을 기준으로 락을 설정**한다.
- DML(INSERT, UPDATE, DELETE) 작업에 대한 락으로, **가장 일반적으로 사용하는 락**이다.

---

# 4. 블로킹(Blocking)이란 무엇인가?

## 1. 개념
**블로킹(Blocking)**이란 락 간(배타-배타, 배타-공유)의 경합이 발생해 특정 트랜잭션이 **작업을 진행하지 못하고 멈춰 있는 상태(대기 상태)**를 의미한다.  
공유 락 간에는 블로킹이 발생하지 않지만, **배타 락은 블로킹을 발생**시킨다.

## 2. 해결 방법
- 이전 트랜잭션이 **커밋(commit)**하거나 **롤백(rollback)**해야 블로킹이 해소된다.
- 트랜잭션 크기를 작게 유지하여 짧은 시간 내에 커밋 또는 롤백하도록 설계하는 것도 방법이다.

## 3. 예시
```sql
-- 트랜잭션 A가 실행 중인 쿼리 (행 락 설정)
BEGIN TRANSACTION;
UPDATE accounts SET balance = balance - 500 WHERE id = 1;

-- 트랜잭션 B에서 실행 중인 쿼리 (블로킹 발생)
SELECT * FROM accounts WHERE id = 1;


```

## 5. 데드락(Deadlock)이란 무엇인가?

### 1. 개념
**데드락(Deadlock)**이란 **두 트랜잭션이 서로 상대 트랜잭션의 락이 해제되기를 기다리면서 블로킹 상태에 빠져 해결할 수 없는 상태**를 의미한다.

---

### 2. 예시
![Image](https://github.com/user-attachments/assets/5155fd0b-0b54-4f84-9492-af5906b9bbd3)
1. **세션 A**에서 `Coupon` 데이터에 **X-Lock** 설정  
2. **세션 B**에서 `Member` 테이블에 **X-Lock** 설정  
3. **세션 A**가 **X-Lock이 설정된 `Member` 데이터에 S-Lock**을 요청 → 블로킹 발생  
4. **세션 B**가 **X-Lock이 설정된 `Coupon` 데이터에 S-Lock**을 요청 → 블로킹 발생  
5. `Member`와 `Coupon` 데이터에 서로 S-Lock 요청이 대기 상태에 빠지면서 블로킹이 해제되지 않음  
6. 두 트랜잭션은 상대 트랜잭션이 종료되지 않으면 블로킹이 해결되지 않으므로 **데드락 상태**가 된다.


